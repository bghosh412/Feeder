<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Troubleshooting - Fish Feeder</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .details-section {
      border: 2px solid #1a5c7a;
      margin: 16px 0;
      background: #fff;
    }
    .details-header {
      background: #1a5c7a;
      color: #fff;
      padding: 12px;
      font-weight: bold;
      font-size: 1.1em;
    }
    .details-content {
      padding: 16px;
      border: 2px solid #1a5c7a;
      margin: 0;
    }
    .detail-row {
      margin: 8px 0;
      font-size: 1em;
    }
    .detail-label {
      font-weight: bold;
    }
    .download-btn {
      background: #1a5c7a;
      color: #fff;
      padding: 10px 24px;
      border: none;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      margin-top: 16px;
    }
    .download-btn:hover {
      background: #155068;
    }
  </style>
</head>
<body>
  <script>
    // Load system data on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadSystemData();
      loadMotorSettings();
      loadNtfyChannel();
      
      // Refresh data every 30 seconds
      setInterval(loadSystemData, 30000);
    });

    function loadSystemData() {
      // Get free memory
      fetch('/api/system/memory')
        .then(r => r.json())
        .then(data => {
          const memoryKB = Math.round(data.free_memory / 1024);
          document.getElementById('freeMemory').textContent = memoryKB + 'KB';
        })
        .catch(() => {
          document.getElementById('freeMemory').textContent = 'N/A';
        });

      // Get system uptime
      fetch('/api/system/uptime')
        .then(r => r.json())
        .then(data => {
          const hours = Math.floor(data.uptime / 3600);
          const minutes = Math.floor((data.uptime % 3600) / 60);
          document.getElementById('systemUptime').textContent = hours + ' hours ' + minutes + ' min';
        })
        .catch(() => {
          document.getElementById('systemUptime').textContent = 'N/A';
        });
    }

    function loadNtfyChannel() {
      fetch('/api/config')
        .then(r => r.json())
        .then(data => {
          document.getElementById('ntfyChannel').textContent = data.ntfy_topic || 'N/A';
        })
        .catch(() => {
          document.getElementById('ntfyChannel').textContent = 'N/A';
        });
    }

    function loadMotorSettings() {
      fetch('/api/calibration')
        .then(r => r.json())
        .then(data => {
          document.getElementById('dutyCycle').textContent = data.duty_cycle || 'N/A';
          document.getElementById('pulseWidth').textContent = (data.pulse_duration || 'N/A') + 'ms';
        })
        .catch(() => {
          document.getElementById('dutyCycle').textContent = 'N/A';
          document.getElementById('pulseWidth').textContent = 'N/A';
        });
    }

    function downloadLog() {
      fetch('/api/events')
        .then(r => r.json())
        .then(data => {
          // Convert events to CSV format
          let csv = 'Timestamp,Event Type,Details\n';
          if (data.events && data.events.length > 0) {
            data.events.forEach(event => {
              const timestamp = event.timestamp || '';
              const eventType = event.event_type || '';
              const details = (event.details || '').replace(/,/g, ';'); // Replace commas in details
              csv += timestamp + ',' + eventType + ',' + details + '\n';
            });
          } else {
            csv += 'No events found\n';
          }
          
          // Create download link
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'feeder_log_' + new Date().toISOString().split('T')[0] + '.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          alert('Failed to download log: ' + err.message);
        });
    }

    function checkOTAUpdate() {
      const btn = document.getElementById('otaCheckBtn');
      const status = document.getElementById('otaStatus');
      
      btn.disabled = true;
      btn.textContent = 'Checking...';
      status.textContent = 'Checking for updates...';
      status.style.color = '#1a5c7a';
      
      fetch('/api/ota/check')
        .then(r => r.json())
        .then(data => {
          if (data.update_available) {
            status.textContent = 'Update available: v' + data.version;
            status.style.color = '#28a745';
            
            // Show download button
            const downloadBtn = document.getElementById('otaDownloadBtn');
            downloadBtn.style.display = 'inline-block';
            downloadBtn.onclick = function() { downloadOTAUpdate(data.version); };
          } else {
            status.textContent = 'No updates available. You are up to date!';
            status.style.color = '#28a745';
          }
          btn.disabled = false;
          btn.textContent = 'Check for Updates';
        })
        .catch(err => {
          status.textContent = 'Error checking for updates: ' + err.message;
          status.style.color = '#dc3545';
          btn.disabled = false;
          btn.textContent = 'Check for Updates';
        });
    }

    function downloadOTAUpdate(version) {
      const btn = document.getElementById('otaDownloadBtn');
      const status = document.getElementById('otaStatus');
      
      btn.disabled = true;
      btn.textContent = 'Downloading...';
      status.textContent = 'Downloading update v' + version + '...';
      status.style.color = '#1a5c7a';
      
      fetch('/api/ota/update', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            status.textContent = 'Update downloaded successfully! Device will reboot in 5 seconds...';
            status.style.color = '#28a745';
            
            // Auto-reboot after 5 seconds
            setTimeout(function() {
              fetch('/api/system/reboot', { method: 'POST' });
            }, 5000);
          } else {
            status.textContent = 'Update failed: ' + (data.error || 'Unknown error');
            status.style.color = '#dc3545';
            btn.disabled = false;
            btn.textContent = 'Retry Update';
          }
        })
        .catch(err => {
          status.textContent = 'Error downloading update: ' + err.message;
          status.style.color = '#dc3545';
          btn.disabled = false;
          btn.textContent = 'Retry Update';
        });
    }
  </script>

  <div class="header">
    <div class="header-content">
      <div class="header-logo">
        <img src="assets/images/Header.png" alt="Fish Feeder Logo">
      </div>
      <div class="header-title">
        <h1>Keep your Fish full</h1>
      </div>
    </div>
  </div>

  <div style="display:flex;">
    <div class="sidebar">
      <b>Quick Links</b><br>
      <a href="index.html" class="quick-link">Home</a>
      <a href="setschedule.html" class="quick-link">Set Feeding Schedule</a>
      <a href="feednow.html" class="quick-link">Feed Now !!!</a>
      <a href="setquantity.html" class="quick-link">Set Quantity</a>
      <a href="calibration.html" class="quick-link">Calibration</a>
      <a href="troubleshooting.html" class="quick-link">Troubleshooting</a>
    </div>

    <div style="flex:1; padding:8px;">
      <h2 style="margin-top: 8px;">Troubleshooting Details</h2>

      <!-- System Details Section -->
      <div class="details-section">
        <div class="details-header">System details:</div>
        <div class="details-content">
          <div class="detail-row">
            <span class="detail-label">Free memory:</span> <span id="freeMemory">Loading...</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">System Up time:</span> <span id="systemUptime">Loading...</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Ntfy Channel Name:</span> <span id="ntfyChannel">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Motor Details Section -->
      <div class="details-section">
        <div class="details-header">Motor details:</div>
        <div class="details-content">
          <div class="detail-row">
            <span class="detail-label">Duty Cycle:</span> <span id="dutyCycle">Loading...</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Pulse Width:</span> <span id="pulseWidth">Loading...</span>
          </div>
        </div>
      </div>

      <!-- OTA Update Section -->
      <div class="details-section">
        <div class="details-header">Firmware Update (OTA):</div>
        <div class="details-content">
          <div class="detail-row">
            <button id="otaCheckBtn" class="download-btn" onclick="checkOTAUpdate()">Check for Updates</button>
            <button id="otaDownloadBtn" class="download-btn" style="display:none; margin-left:10px;">Download Update</button>
          </div>
          <div class="detail-row">
            <span id="otaStatus" style="font-style:italic; color:#666;"></span>
          </div>
        </div>
      </div>

      <!-- Download Log Button -->
      <button class="download-btn" onclick="downloadLog()">Download Log</button>
    </div>
  </div>
</body>
</html>
