<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Motor Setup - Fish Feeder</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .calibration-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .calibration-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .calibration-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .param-row {
      display: flex;
      align-items: center;
      margin: 15px 0;
      gap: 10px;
    }
    .param-row label {
      flex: 0 0 120px;
      font-weight: bold;
    }
    .param-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .param-row button {
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .param-row button:hover {
      background: #0b7dda;
    }
    .test-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    .test-buttons button {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    .test-buttons button:hover {
      background: #45a049;
    }
    .test-buttons button.danger {
      background: #f44336;
    }
    .test-buttons button.danger:hover {
      background: #da190b;
    }
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
      display: none;
    }
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .info-text {
      color: #666;
      font-size: 13px;
      margin-top: 5px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-logo">
        <img src="assets/images/Header.png" alt="Fish Feeder Logo">
      </div>
      <div class="header-title">
        <h1>Motor Setup & Calibration</h1>
      </div>
    </div>
  </div>
  <div style="display:flex;">
    <div class="sidebar">
      <b>Quick Links</b><br>
      <a href="index.html" class="quick-link">Home</a>
      <a href="setschedule.html" class="quick-link">Set Feeding Schedule</a>
      <a href="feednow.html" class="quick-link">Feed Now !!!</a>
      <a href="setquantity.html" class="quick-link">Set Quantity</a>
      <a href="calibration.html" class="quick-link">Calibration</a>
      <a href="motor_setup.html" class="quick-link">Motor Setup</a>
    </div>
    <div style="flex:1; padding:8px;">
      <div class="calibration-container">
        
        <!-- Step 1: Incremental Movement -->
        <div class="calibration-section">
          <h3>Step 1: Move Motor Incrementally</h3>
          <div class="param-row">
            <label>Duty Step Size:</label>
            <input type="number" id="duty-step" value="10" min="1" max="50">
            <span class="info-text">(How much to change duty per click)</span>
          </div>
          <div class="param-row">
            <label>Current Duty:</label>
            <input type="number" id="current-duty" value="128" readonly>
            <span class="info-text">(Current PWM duty value)</span>
          </div>
          <div class="test-buttons">
            <button onclick="moveDuty(-1)">◀ Decrease Duty</button>
            <button onclick="moveDuty(1)">Increase Duty ▶</button>
            <button onclick="stopMotor()" class="danger">⏹ Stop Motor</button>
            <button onclick="resetDuty()">Reset to 128</button>
          </div>
          <div class="info-text" style="margin-top: 10px;">
            Click buttons to move the motor incrementally. Click "Stop Motor" to deinitialize and stop the servo. Note the duty values where the motor just starts moving in each direction.
          </div>
        </div>

        <!-- Step 2: Record Observations -->
        <div class="calibration-section">
          <h3>Step 2: Record Your Observations</h3>
          <div class="param-row">
            <label>Min Duty (Reverse):</label>
            <input type="number" id="observed-min-duty" placeholder="When motor starts reverse">
            <button onclick="captureCurrentDuty('observed-min-duty')">Capture</button>
          </div>
          <div class="param-row">
            <label>Stop Duty (No Move):</label>
            <input type="number" id="observed-stop-duty" placeholder="When motor stops">
            <button onclick="captureCurrentDuty('observed-stop-duty')">Capture</button>
          </div>
          <div class="param-row">
            <label>Max Duty (Forward):</label>
            <input type="number" id="observed-max-duty" placeholder="When motor starts forward">
            <button onclick="captureCurrentDuty('observed-max-duty')">Capture</button>
          </div>
          <div class="info-text" style="margin-top: 10px;">
            Move the motor until you find:<br>
            • The lowest duty where it moves in reverse (Min)<br>
            • The duty where it stops completely (Stop)<br>
            • The highest duty where it moves forward (Max)<br>
            Click "Capture" to record the current duty value.
          </div>
        </div>

        <!-- Step 3: Save Calibration -->
        <div class="calibration-section">
          <h3>Step 3: Save Calibration</h3>
          <button onclick="saveCalibration()" style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">Save Calibration Values</button>
          <div class="info-text" style="margin-top: 10px;">
            This will save your observed min, stop, and max duty values for future use.
          </div>
        </div>

        <!-- Current Saved Values -->
        <div class="calibration-section">
          <h3>Current Saved Values</h3>
          <div class="param-row">
            <label>Min Duty:</label>
            <input type="number" id="saved-min-duty" readonly>
          </div>
          <div class="param-row">
            <label>Stop Duty:</label>
            <input type="number" id="saved-stop-duty" readonly>
          </div>
          <div class="param-row">
            <label>Max Duty:</label>
            <input type="number" id="saved-max-duty" readonly>
          </div>
          <button onclick="loadCurrentValues()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Saved Values</button>
        </div>

        <!-- Status Message -->
        <div id="status-message" class="status-message"></div>

      </div>
    </div>
  </div>

  <script>
  // Use relative paths so the page works when served from the device
  const API_BASE = '';

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
      statusEl.style.display = 'block';
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }

    async function moveDuty(direction) {
      // direction: -1 (decrease) or 1 (increase)
      const stepSize = parseInt(document.getElementById('duty-step').value) || 10;
      const currentDutyEl = document.getElementById('current-duty');
      let currentDuty = parseInt(currentDutyEl.value) || 128;
      
      currentDuty += direction * stepSize;
      
      // Clamp to valid PWM range (typically 0-1023 for ESP, but servo uses ~20-250)
      if (currentDuty < 0) currentDuty = 0;
      if (currentDuty > 1023) currentDuty = 1023;
      
      currentDutyEl.value = currentDuty;
      
      try {
        showStatus(`Moving motor to duty ${currentDuty}...`, 'info');
        const response = await fetch(`${API_BASE}/api/calibration/move`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duty: currentDuty })
        });
        if (!response.ok) throw new Error('Failed to move motor');
        const data = await response.json();
        showStatus(`Motor set to duty ${currentDuty}`, 'success');
      } catch (error) {
        showStatus('Error moving motor: ' + error.message, 'error');
      }
    }

    function resetDuty() {
      document.getElementById('current-duty').value = 128;
      moveDuty(0); // Just send the reset value
    }

    async function stopMotor() {
      try {
        showStatus('Stopping motor...', 'info');
        const response = await fetch(`${API_BASE}/api/calibration/stop`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error('Failed to stop motor');
        const data = await response.json();
        showStatus('Motor stopped and deinitialized', 'success');
      } catch (error) {
        showStatus('Error stopping motor: ' + error.message, 'error');
      }
    }

    function captureCurrentDuty(targetInputId) {
      const currentDuty = document.getElementById('current-duty').value;
      document.getElementById(targetInputId).value = currentDuty;
      showStatus(`Captured duty ${currentDuty}`, 'info');
    }

    async function saveCalibration() {
      const minDuty = parseInt(document.getElementById('observed-min-duty').value);
      const stopDuty = parseInt(document.getElementById('observed-stop-duty').value);
      const maxDuty = parseInt(document.getElementById('observed-max-duty').value);
      
      if (isNaN(minDuty) || isNaN(stopDuty) || isNaN(maxDuty)) {
        showStatus('Please fill in all three duty values', 'error');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/calibration/set`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            min_duty: minDuty, 
            stop_duty: stopDuty, 
            max_duty: maxDuty 
          })
        });
        if (!response.ok) throw new Error('Failed to save calibration');
        const data = await response.json();
        showStatus('Calibration saved successfully!', 'success');
        loadCurrentValues();
      } catch (error) {
        showStatus('Error saving calibration: ' + error.message, 'error');
      }
    }

    async function loadCurrentValues() {
      try {
        const response = await fetch(`${API_BASE}/api/calibration/get`);
        if (!response.ok) throw new Error('Failed to load values');
        const data = await response.json();
        document.getElementById('saved-min-duty').value = data.min_duty || 26;
        document.getElementById('saved-stop-duty').value = data.stop_duty || 128;
        document.getElementById('saved-max-duty').value = data.max_duty || 230;
        showStatus('Saved values loaded successfully', 'success');
      } catch (error) {
        showStatus('Error loading values: ' + error.message, 'error');
      }
    }

    // Load values on page load
    window.addEventListener('DOMContentLoaded', loadCurrentValues);
  </script>
</body>
</html>
