<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Calibrate Feeder - Fish Feeder</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .calibration-card { background: #fff; border: 2px solid #176d87; border-radius: 4px; margin: 24px 0; padding: 24px; }
        .calibration-header { font-size: 1.5em; font-weight: bold; color: #176d87; margin-bottom: 20px; }
        .calibration-info { background: #e6f2f5; padding: 16px; border-radius: 4px; margin-bottom: 24px; line-height: 1.6; }
        .calibration-info p { margin: 8px 0; }
        .calibration-status { display: flex; gap: 32px; margin-bottom: 32px; flex-wrap: wrap; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 1.1em; }
        .status-item .label { font-weight: bold; color: #176d87; }
        .status-item .value { background: #176d87; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; min-width: 60px; text-align: center; }
        .calibration-controls { margin-bottom: 24px; }
        .control-group { margin-bottom: 24px; }
        .control-group label { display: block; font-weight: bold; color: #176d87; margin-bottom: 12px; font-size: 1.1em; }
        .button-row { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { border: none; border-radius: 4px; padding: 12px 24px; font-size: 1.1em; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        .btn-adjust { background: #176d87; color: white; min-width: 80px; }
        .btn-adjust:hover { background: #124e63; }
        .btn-adjust:active { transform: scale(0.95); }
        .btn-adjust:disabled { background: #ccc; cursor: not-allowed; }
        .btn-test { background: #28a745; color: white; min-width: 120px; }
        .btn-test:hover { background: #218838; }
        .btn-test:active { transform: scale(0.95); }
        .btn-save { background: #007bff; color: white; min-width: 120px; }
        .btn-save:hover { background: #0056b3; }
        .btn-save:active { transform: scale(0.95); }
        .action-buttons { display: flex; gap: 16px; margin-top: 32px; }
        .message { margin-top: 24px; padding: 16px; border-radius: 4px; display: none; font-weight: bold; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-logo"><img src="assets/images/Header.png" alt="Fish Feeder Logo"></div>
            <div class="header-title"><h1>Keep your Fish full</h1></div>
        </div>
    </div>
    <div style="display:flex">
        <div class="sidebar">
            <b>Quick Links</b><br>
            <a href="index.html" class="quick-link">Home</a>
            <a href="setschedule.html" class="quick-link">Set Feeding Schedule</a>
            <a href="feednow.html" class="quick-link">Feed Now !!!</a>
            <a href="setquantity.html" class="quick-link">Set Quantity</a>
            <a href="calibration.html" class="quick-link active">Calibrate Feeder</a>
            <a href="troubleshooting.html" class="quick-link">Troubleshooting</a>
        </div>
        <div style="flex:1;padding:16px">
            <div class="calibration-card">
                <div class="calibration-header">Calibrate Feeder</div>
                
                <div class="calibration-info">
                    <p>Use this page to calibrate your feeder. If the disk is not disbursing complete food, then press "&lt;" button, otherwise press "&gt;" button. To calibrate faster, you can use the "&lt;&lt;" or "&gt;&gt;" buttons.</p>
                    <p>After adjusting, press "Test" button few times to verify the calibration.</p>
                    <p>Once calibration is completed, press "Save" button to save the calibration settings.</p>
                </div>

                <div class="calibration-status">
                    <div class="status-item">
                        <span class="label">Current Duty Cycle:</span>
                        <span class="value" id="duty-cycle-value">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Current Pulse Duration:</span>
                        <span class="value" id="pulse-duration-value">Loading...</span> ms
                    </div>
                </div>

                <div class="calibration-controls">
                    <div class="control-group">
                        <label>Adjust Duty Cycle:</label>
                        <div class="button-row">
                            <button class="btn btn-adjust" id="duty-decrease-large">&lt;&lt;</button>
                            <button class="btn btn-adjust" id="duty-decrease">&lt;</button>
                            <button class="btn btn-adjust" id="duty-increase">&gt;</button>
                            <button class="btn btn-adjust" id="duty-increase-large">&gt;&gt;</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Adjust Pulse Duration:</label>
                        <div class="button-row">
                            <button class="btn btn-adjust" id="duration-decrease">&lt;</button>
                            <button class="btn btn-adjust" id="duration-increase">&gt;</button>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-test" id="test-btn">Test</button>
                        <button class="btn btn-save" id="save-btn">Save</button>
                    </div>
                </div>

                <div class="message" id="message"></div>
            </div>
        </div>
    </div>
    <script>
// Calibration page JavaScript
const API_BASE = '';

// DOM elements
let dutyCycleDisplay;
let pulseDurationDisplay;
let messageDiv;

// Button elements
let dutyDecreaseLargeBtn;
let dutyDecreaseBtn;
let dutyIncreaseBtn;
let dutyIncreaseLargeBtn;
let durationDecreaseBtn;
let durationIncreaseBtn;
let testBtn;
let saveBtn;

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    dutyCycleDisplay = document.getElementById('duty-cycle-value');
    pulseDurationDisplay = document.getElementById('pulse-duration-value');
    messageDiv = document.getElementById('message');
    
    // Duty cycle buttons
    dutyDecreaseLargeBtn = document.getElementById('duty-decrease-large');
    dutyDecreaseBtn = document.getElementById('duty-decrease');
    dutyIncreaseBtn = document.getElementById('duty-increase');
    dutyIncreaseLargeBtn = document.getElementById('duty-increase-large');
    
    // Pulse duration buttons
    durationDecreaseBtn = document.getElementById('duration-decrease');
    durationIncreaseBtn = document.getElementById('duration-increase');
    
    // Action buttons
    testBtn = document.getElementById('test-btn');
    saveBtn = document.getElementById('save-btn');
    
    // Attach event listeners
    dutyDecreaseLargeBtn.addEventListener('click', () => adjustDutyCycle(10));
    dutyDecreaseBtn.addEventListener('click', () => adjustDutyCycle(1));
    dutyIncreaseBtn.addEventListener('click', () => adjustDutyCycle(-1));
    dutyIncreaseLargeBtn.addEventListener('click', () => adjustDutyCycle(-10));
    
    durationDecreaseBtn.addEventListener('click', () => adjustPulseDuration(-5));
    durationIncreaseBtn.addEventListener('click', () => adjustPulseDuration(5));
    
    testBtn.addEventListener('click', testCalibration);
    saveBtn.addEventListener('click', saveCalibration);
    
    // Load current calibration values
    loadCalibration();
});

// Load current calibration from backend
async function loadCalibration() {
    try {
        const response = await fetch(`${API_BASE}/api/calibration/get`);
        if (!response.ok) {
            throw new Error('Failed to load calibration');
        }
        const data = await response.json();
        dutyCycleDisplay.textContent = data.duty_cycle;
        pulseDurationDisplay.textContent = data.pulse_duration;
    } catch (error) {
        console.error('Error loading calibration:', error);
        showMessage('Error loading calibration values', 'error');
    }
}

// Adjust duty cycle by increment
async function adjustDutyCycle(increment) {
    disableAllButtons();
    try {
        const response = await fetch(`${API_BASE}/api/calibration/adjust_duty`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ increment: increment })
        });
        
        if (!response.ok) {
            throw new Error('Failed to adjust duty cycle');
        }
        
        const data = await response.json();
        dutyCycleDisplay.textContent = data.duty_cycle;
        pulseDurationDisplay.textContent = data.pulse_duration;
        showMessage(`Duty cycle adjusted to ${data.duty_cycle}`, 'success');
    } catch (error) {
        console.error('Error adjusting duty cycle:', error);
        showMessage('Error adjusting duty cycle', 'error');
    } finally {
        enableAllButtons();
    }
}

// Adjust pulse duration by increment
async function adjustPulseDuration(increment) {
    disableAllButtons();
    try {
        const response = await fetch(`${API_BASE}/api/calibration/adjust_duration`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ increment: increment })
        });
        
        if (!response.ok) {
            throw new Error('Failed to adjust pulse duration');
        }
        
        const data = await response.json();
        dutyCycleDisplay.textContent = data.duty_cycle;
        pulseDurationDisplay.textContent = data.pulse_duration;
        showMessage(`Pulse duration adjusted to ${data.pulse_duration}ms`, 'success');
    } catch (error) {
        console.error('Error adjusting pulse duration:', error);
        showMessage('Error adjusting pulse duration', 'error');
    } finally {
        enableAllButtons();
    }
}

// Test current calibration
async function testCalibration() {
    disableAllButtons();
    testBtn.textContent = 'Testing...';
    try {
        const response = await fetch(`${API_BASE}/api/calibration/test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error('Failed to test calibration');
        }
        
        const data = await response.json();
        if (data.success) {
            showMessage(`Test successful! Duty: ${data.duty_cycle}, Duration: ${data.pulse_duration}ms`, 'success');
        } else {
            showMessage('Test failed: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error testing calibration:', error);
        showMessage('Error testing calibration', 'error');
    } finally {
        testBtn.textContent = 'Test';
        enableAllButtons();
    }
}

// Save current calibration
async function saveCalibration() {
    disableAllButtons();
    saveBtn.textContent = 'Saving...';
    try {
        const dutyCycle = parseInt(dutyCycleDisplay.textContent);
        const pulseDuration = parseInt(pulseDurationDisplay.textContent);
        
        const response = await fetch(`${API_BASE}/api/calibration/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                duty_cycle: dutyCycle,
                pulse_duration: pulseDuration
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save calibration');
        }
        
        const data = await response.json();
        showMessage(`Calibration saved successfully! Duty: ${data.duty_cycle}, Duration: ${data.pulse_duration}ms`, 'success');
    } catch (error) {
        console.error('Error saving calibration:', error);
        showMessage('Error saving calibration', 'error');
    } finally {
        saveBtn.textContent = 'Save';
        enableAllButtons();
    }
}

// Display message to user
function showMessage(text, type) {
    messageDiv.textContent = text;
    messageDiv.className = 'message ' + type;
    messageDiv.style.display = 'block';
    
    // Auto-hide success messages after 3 seconds
    if (type === 'success') {
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    }
}

// Disable all buttons during operations
function disableAllButtons() {
    dutyDecreaseLargeBtn.disabled = true;
    dutyDecreaseBtn.disabled = true;
    dutyIncreaseBtn.disabled = true;
    dutyIncreaseLargeBtn.disabled = true;
    durationDecreaseBtn.disabled = true;
    durationIncreaseBtn.disabled = true;
    testBtn.disabled = true;
    saveBtn.disabled = true;
}

// Enable all buttons after operations
function enableAllButtons() {
    dutyDecreaseLargeBtn.disabled = false;
    dutyDecreaseBtn.disabled = false;
    dutyIncreaseBtn.disabled = false;
    dutyIncreaseLargeBtn.disabled = false;
    durationDecreaseBtn.disabled = false;
    durationIncreaseBtn.disabled = false;
    testBtn.disabled = false;
    saveBtn.disabled = false;
}
</script>
</body>
</html>
